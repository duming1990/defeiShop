/**
 * Author IIInsomnia
 *
 * var cityPicker = new HzwCityPicker({
 *      data: data,             城市数据
 *      target: 'cityChoice',   目标元素id（如：文本框，该值为城市名称）
 *      valType: 'k-v',         隐藏域的值类型（取值有：'k' => 只存ID，'k-v' => 存ID和名称，格式为：id-name）
 *      hideCityInput: {        城市隐藏域
 *          name: 'city',       隐藏域name
 *          id: 'city'          隐藏域id
 *          val: '2'            默认值
 *      },
 *      hideProvinceInput: {    省份隐藏域（如果不需要存省份，此项可以省略）
 *          name: 'province',   隐藏域name
 *          id: 'province'      隐藏域id
 *          val: '1'            默认值
 *      },
 *      callback: function(){   回调函数，选择城市后调用
 *          alert('OK');
 *      }
 * });
 *
 * cityPicker.init();
 */

var HzwCityPicker = function(a) {
    this.template = $('<div class="hzw-city-picker" id="hzw_city_picker"><div class="hzw-wrap"><p>选择省份<b class="hzw-close">关闭</b></p><ul class="hzw-province-wrap" id="hzw_province_wrap"></ul></div></div>');
    this.hot_city = $("#hzw_hot_city", this.template);
    this.province_wrap = $("#hzw_province_wrap", this.template);
    this.province_close = $(".hzw-close", this.template);
    this.settings = {
        data: a.data,
        target: $("#" + a.target),
        valType: a.valType || "k",
        multiple: a.multiple || false
    };
    this.hideProvinceInput = a.hideProvinceInput ? $("<input>", {
        type: "hidden",
        name: a.hideProvinceInput.name,
        id: a.hideProvinceInput.id,
        val: a.hideProvinceInput.val || ""
    }) : false;
    this.hideCityInput = $("<input>", {
        type: "hidden",
        name: a.hideCityInput.name,
        id: a.hideCityInput.id,
        val: a.hideCityInput.val || ""
    });
    this.callback = a.callback || "";
    this.flag = true;
};

HzwCityPicker.prototype = {
    init: function() {
        var a = this;
        a.settings.target.after(a.hideCityInput);
        if (a.hideProvinceInput) a.settings.target.after(a.hideProvinceInput);
        a.addTargetEvent();
    },
    buildCityPicker: function() {
        var a = this;
        a.addHotCityTpl();
        a.addProvinceTpl();
        a.addMouseEvent();
        a.addProvinceEvent();
        a.addCityEvent();
        a.closeProvince();
    },
    addHotCityTpl: function() {
        var a = this;
        var b = a.settings.data.hot;
        var c = "";
        for (var i = 0, len = b.length; i < len; i++) {
            c += '<li class="hzw-hot-city" data-id="' + b[i]["id"] + '" data-name="' + b[i]["name"] + '" data-pid="' + b[i]["pid"] + '" data-pname="' + b[i]["pname"] + '">' + b[i]["name"] + "</li>";
        }
        a.hot_city.html(c);
    },
    addProvinceTpl: function() {
        var a = this;
        var b = a.settings.data.province;
        var c = "";
        for (var i = 0, len = b.length; i < len; i++) {
            c += '<li class="hzw-province" data-id="' + b[i]["id"] + '" data-name="' + b[i]["name"] + '"><ul class="hzw-city-wrap"></ul><div class="hzw-province-name" title="'+b[i]["name"]+'">' + b[i]["name"] + "</div></li>";
        }
        a.province_wrap.html(c);
    },
    addCityTpl: function(a) {
        var b = this;
        var c = a.data("id");
        var d = a.position();
        var e = b.settings.data.province;
        var f;
        var g = "";
        for (var i = 0, plen = e.length; i < plen; i++) {
            if (e[i]["id"] == parseInt(c)) {
                f = e[i]["city"];
                break;
            }
        }
        for (var j = 0, clen = f.length; j < clen; j++) {
            g += '<li class="hzw-city" data-id="' + f[j]["id"] + '" data-name="' + f[j]["name"] + '" data-full-name="' + f[j]["full_name"] + '" title="' + f[j]["name"] + '">' + f[j]["name"] + "</li>";
        }
        a.find(".hzw-city-wrap").html(g).css("left", "-" + (d.left - 53) + "px").slideDown();
    },
    addMouseEvent: function() {
        var a = this;
        a.template.mouseenter(function() {
            a.flag = false;
        }).mouseleave(function() {
            a.flag = true;
        });
    },
    addProvinceEvent: function() {
        var b = this;
        b.province_wrap.on("click", ".hzw-province", function() {
            var a = $(this);
            if (!a.hasClass("active")) {
                b.province_wrap.find(".hzw-province").removeClass("active");
                b.province_wrap.find(".hzw-province-name").removeClass("active");
                b.province_wrap.find(".hzw-city-wrap").hide().children().remove();
                a.addClass("active");
                a.find(".hzw-province-name").addClass("active");
                b.addCityTpl(a);
            } else {
                a.removeClass("active");
                a.find(".hzw-province-name").removeClass("active");
                a.find(".hzw-city-wrap").hide().children().remove();
            }
        });
    },
    addCityEvent: function() {
        var g = this;
        g.hot_city.on("click", ".hzw-hot-city", function() {
            var a = $(this);
            var b = a.data("id");
            var c = a.data("name");
            var x = a.data("full-name");
            g.settings.target.text(x);
            if (g.settings.valType == "k-v") {
                g.hideCityInput.val(b + "-" + c);
            } else {
                g.hideCityInput.val(b);
            }
            if (g.hideProvinceInput) {
                var d = a.data("pid");
                var e = a.data("pname");
                if (g.settings.valType == "k-v") {
                    g.hideProvinceInput.val(d + "-" + e);
                } else {
                    g.hideProvinceInput.val(d);
                }
            }
            g.template.remove();
            if (g.callback) g.callback();
        });
        g.province_wrap.on("click", ".hzw-city", function() {
            var a = $(this);
            var b = a.data("id");
            var c = a.data("name");
            var x = a.data("full-name");
            g.settings.target.text(x);
            if (g.settings.valType == "k-v") {
                g.hideCityInput.val(b + "-" + c);
            } else {
                g.hideCityInput.val(b);
            }
            if (g.hideProvinceInput) {
                var d = a.parent().parent();
                var e = d.data("id");
                var f = d.data("name");
                if (g.settings.valType == "k-v") {
                    g.hideProvinceInput.val(e + "-" + f);
                } else {
                    g.hideProvinceInput.val(e);
                }
            }
            g.template.remove();
            if (g.callback) g.callback();
        });
    },
    closeProvince: function() {
    	 var g = this;
         g.province_close.on("click", function() {
             g.template.remove();
         });
    },
    addTargetEvent: function() {
        var d = this;
        d.settings.target.click(function() {
            var a = $(this);
            d.buildCityPicker();
            var b = a.offset();
            var c = b.top + a.outerHeight() + 15;
            d.template.css({
                left: b.left,
                top: c
            });
            $("body").append(d.template);
        }).blur(function() {
            if (d.flag) {
                d.template.remove();
                d.flag = true;
            }
        });
    }
};
